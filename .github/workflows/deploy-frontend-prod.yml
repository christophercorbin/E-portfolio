name: Deploy Portfolio to AWS (S3 + CloudFront)

permissions:
  id-token: write  # Required for OIDC
  contents: read

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only deploy on push events, not pull requests (Dependabot PRs don't have secrets access)
    if: github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::590716168923:role/GitHubActionsDeployRole
        role-session-name: GitHubActions-ProdFrontend
        aws-region: us-east-1
        
    - name: Verify AWS CLI and credentials
      run: |
        echo "AWS CLI version:"
        aws --version
        echo "Testing AWS credentials:"
        aws sts get-caller-identity
        
    - name: Validate HTML
      run: |
        echo "Validating HTML structure..."
        # Check if required files exist
        test -f index.html || { echo "ERROR: index.html missing"; exit 1; }
        test -f styles.css || { echo "ERROR: styles.css missing"; exit 1; }
        test -f script.js || { echo "ERROR: script.js missing"; exit 1; }
        echo "SUCCESS: All required files present"
        
    - name: Ensure S3 bucket exists
      env:
        S3_BUCKET: christopher-corbin-portfolio-20251005195625
        CLOUDFRONT_OAI: E3QBWYO0NRQX8V
      run: |
        echo "üîç Checking if production bucket exists..."
        
        if aws s3 ls "s3://$S3_BUCKET" 2>&1 | grep -q 'NoSuchBucket'; then
          echo "üì¶ Creating production S3 bucket: $S3_BUCKET"
          
          aws s3 mb "s3://$S3_BUCKET" --region us-east-1
          
          echo "üåê Configuring bucket for website hosting..."
          aws s3 website "s3://$S3_BUCKET" \
            --index-document index.html \
            --error-document index.html
          
          echo "üîí Setting bucket policy for CloudFront OAI access..."
          aws s3api put-bucket-policy --bucket "$S3_BUCKET" --policy "{
            \"Version\": \"2012-10-17\",
            \"Statement\": [
              {
                \"Sid\": \"AllowCloudFrontOAI\",
                \"Effect\": \"Allow\",
                \"Principal\": {
                  \"AWS\": \"arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity $CLOUDFRONT_OAI\"
                },
                \"Action\": \"s3:GetObject\",
                \"Resource\": \"arn:aws:s3:::$S3_BUCKET/*\"
              }
            ]
          }"
          
          echo "üè∑Ô∏è  Adding tags..."
          aws s3api put-bucket-tagging --bucket "$S3_BUCKET" --tagging "TagSet=[{Key=Environment,Value=prod},{Key=Project,Value=christopher-corbin-portfolio},{Key=ManagedBy,Value=GitHubActions}]"
          
          echo "‚úÖ Production bucket created and configured successfully!"
          echo "üìù Note: Bucket is configured for CloudFront access only (not public)"
        else
          echo "‚úÖ Production bucket already exists"
        fi
        
    - name: Deploy to S3
      env:
        S3_BUCKET: christopher-corbin-portfolio-20251005195625
      run: |
        echo "Deploying to S3 bucket: $S3_BUCKET"
        
        SYNC_COMMON="--exclude '*.json' --exclude '*.sh' --exclude '*.md' --exclude '.DS_Store' --exclude '.git/*' --exclude '.github/*' --exclude 'node_modules/*' --exclude 'docs/*' --exclude 'aws-config/*' --exclude 'infrastructure/*' --exclude 'src/*' --exclude 'tests/*' --exclude '.editorconfig' --exclude '.eslintrc.json' --exclude '.prettierrc.json' --exclude 'package*.json' --exclude 'requirements*'"

        # 1. Sync all files first (sets default short cache)
        eval aws s3 sync . s3://$S3_BUCKET --delete $SYNC_COMMON \
          --cache-control "max-age=300"

        # 2. Override CSS files with long cache
        aws s3 sync . s3://$S3_BUCKET \
          --exclude "*" --include "*.css" \
          --cache-control "max-age=31536000"

        # 3. Override JS files with long cache
        aws s3 sync . s3://$S3_BUCKET \
          --exclude "*" --include "*.js" \
          --cache-control "max-age=31536000"

        # 4. Override images with long cache
        aws s3 sync . s3://$S3_BUCKET \
          --exclude "*" --include "*.jpg" --include "*.jpeg" --include "*.png" --include "*.gif" --include "*.svg" --include "*.webp" --include "*.ico" --include "*.pdf" \
          --cache-control "max-age=31536000"
          
        echo "SUCCESS: S3 deployment completed successfully!"
        
    - name: Invalidate CloudFront Cache
      env:
        DISTRIBUTION_ID: E34Q2E7TZIYZAB
        CUSTOM_DOMAIN: christophercorbin.cloud
      run: |
        echo "üìù S3 deployment completed successfully!"
        echo ""
        echo "‚ö†Ô∏è  Note: CloudFront distribution is in management account (438465156498)"
        echo "üîÑ To invalidate CloudFront cache, run this command in the management account:"
        echo ""
        echo "aws cloudfront create-invalidation \\"
        echo "  --distribution-id E34Q2E7TZIYZAB \\"
        echo "  --paths '/*'"
        echo ""
        echo "Or use the AWS Console:"
        echo "1. Log into management account (438465156498)"
        echo "2. Go to CloudFront ‚Üí Distributions ‚Üí E34Q2E7TZIYZAB"
        echo "3. Click 'Invalidations' tab ‚Üí 'Create invalidation'"
        echo "4. Enter path: /*"
        echo ""
        echo "üåê Your changes will be live at: https://christophercorbin.cloud"
        echo "‚è≥ Cache invalidation takes 1-3 minutes to complete"
        
    - name: Verify deployment
      env:
        S3_BUCKET: christopher-corbin-portfolio-20251005195625
        CUSTOM_DOMAIN: https://christophercorbin.cloud
        CLOUDFRONT_URL: https://d30iyriy15xq9k.cloudfront.net
      run: |
        echo "Verifying deployment..."
        
        # Check if CloudFront is accessible
        HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $CLOUDFRONT_URL || echo "000")
        
        if [ "$HTTP_STATUS" = "200" ]; then
          echo "‚úÖ SUCCESS: Website is accessible via CloudFront"
          echo "üåê Custom Domain: $CUSTOM_DOMAIN"
          echo "‚òÅÔ∏è  CloudFront URL: $CLOUDFRONT_URL"
          echo "Deployment Summary:"
          aws s3 ls s3://$S3_BUCKET --human-readable --summarize | tail -2
        else
          echo "‚ùå ERROR: Website not accessible via CloudFront. HTTP Status: $HTTP_STATUS"
          echo "‚ö†Ô∏è  This might be temporary during CloudFront cache invalidation"
        fi
        
    - name: Performance check
      env:
        WEBSITE_URL: http://christopher-corbin-portfolio-20251005195625.s3-website-us-east-1.amazonaws.com
      run: |
        echo "Running basic performance check..."
        
        # Measure response time
        RESPONSE_TIME=$(curl -s -w "%{time_total}" -o /dev/null $WEBSITE_URL)
        echo "Response time: ${RESPONSE_TIME}s"
        
        # Check file sizes
        echo "File sizes:"
        aws s3 ls s3://christopher-corbin-portfolio-20251005195625 --human-readable | grep -E "\.(html|css|js)$" || true
        
    - name: Security scan
      run: |
        echo "Running basic security checks..."
        
        # Check for sensitive information in files
        echo "Scanning for potential secrets..."
        if grep -r -i "password\|secret\|key" --include="*.html" --include="*.css" --include="*.js" . | grep -v "skill-item\|api-key\|access-key" | head -5; then
          echo "WARNING: Potential sensitive data found (review above)"
        else
          echo "SUCCESS: No obvious sensitive data detected"
        fi
        
        # Check HTTPS readiness
        echo "HTTPS Readiness check..."
        if grep -q "http://" index.html; then
          echo "WARNING: Found HTTP links - consider updating for HTTPS"
        else
          echo "SUCCESS: No HTTP links found"
        fi
        
    - name: Generate deployment report
      env:
        S3_BUCKET: christopher-corbin-portfolio-20251005195625
        WEBSITE_URL: http://christopher-corbin-portfolio-20251005195625.s3-website-us-east-1.amazonaws.com
      run: |
        echo "Deployment Report"
        echo "=================="
        echo "Website URL: $WEBSITE_URL"
        echo "S3 Bucket: $S3_BUCKET"
        echo "Deploy Time: $(date)"
        echo "Built by: GitHub Actions"
        echo "Triggered by: ${{ github.actor }}"
        echo "Commit: ${{ github.sha }}"
        echo ""
        echo "Bucket Contents:"
        aws s3 ls s3://$S3_BUCKET --human-readable
        echo ""
        echo "SUCCESS: Portfolio deployment completed successfully!"
        echo ""
        echo "Next steps:"
        echo "   ‚Ä¢ Visit your portfolio: $WEBSITE_URL"
        echo "   ‚Ä¢ Set up custom domain with CloudFront"
        echo "   ‚Ä¢ Add SSL certificate for HTTPS"
