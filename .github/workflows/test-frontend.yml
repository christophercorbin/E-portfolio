name: Test Frontend (JavaScript)

permissions:
  contents: read

on:
  push:
    branches: [ main, dev-backend-integration, Workflowupdate ]
    paths:
      - '*.js'
      - '*.html'
      - '*.css'
      - 'package.json'
      - '.eslintrc.json'
      - '.prettierrc.json'
      - '.github/workflows/test-frontend.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '*.js'
      - '*.html'
      - '*.css'
      - 'package.json'
  workflow_dispatch:

jobs:
  lint-and-format:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        echo "üì¶ Installing dependencies..."
        npm ci
    
    - name: Check code formatting with Prettier
      run: |
        echo "üé® Checking code formatting..."
        npm run format:check
        echo "‚úÖ Code formatting is correct"
    
    - name: Lint JavaScript with ESLint
      run: |
        echo "üîç Running ESLint..."
        npm run lint
        echo "‚úÖ ESLint check passed"
    
    - name: Validate HTML structure
      run: |
        echo "üîç Validating HTML files..."
        
        # Check if required files exist
        test -f index.html || { echo "‚ùå ERROR: index.html missing"; exit 1; }
        test -f resume.html || { echo "‚ùå ERROR: resume.html missing"; exit 1; }
        test -f styles.css || { echo "‚ùå ERROR: styles.css missing"; exit 1; }
        test -f script.js || { echo "‚ùå ERROR: script.js missing"; exit 1; }
        
        # Check for basic HTML structure
        for file in index.html resume.html; do
          if ! grep -iq "doctype html" $file; then
            echo "‚ùå ERROR: $file missing DOCTYPE declaration"
            exit 1
          fi
          
          if ! grep -q "<html" $file; then
            echo "‚ùå ERROR: $file missing html tag"
            exit 1
          fi
        done
        
        echo "‚úÖ HTML validation passed"
    
    - name: Check for console.log statements
      run: |
        echo "üîç Checking for debug statements..."
        
        # Allow console.log but warn about it
        if grep -n "console\.log" script.js config.js config-dev.js 2>/dev/null; then
          echo "‚ö†Ô∏è  WARNING: Found console.log statements (consider removing for production)"
        else
          echo "‚úÖ No console.log statements found"
        fi
    
    - name: Check for hardcoded secrets
      run: |
        echo "üîí Scanning for potential secrets..."
        
        # Look for common secret patterns (but exclude comments and variable names)
        if grep -iE "(api[_-]?key|secret|password|token|aws[_-]?access)" *.js *.html | grep -v "API_CONFIG\|placeholder\|example\|TODO\|//"; then
          echo "‚ö†Ô∏è  WARNING: Potential secrets or API keys found - please review"
        else
          echo "‚úÖ No hardcoded secrets detected"
        fi
    
    - name: Check file sizes
      run: |
        echo "üìä Checking file sizes..."
        
        # Warn if JavaScript files are too large (> 500KB)
        for file in *.js; do
          size=$(wc -c < "$file")
          size_kb=$((size / 1024))
          echo "  $file: ${size_kb}KB"
          
          if [ $size -gt 512000 ]; then
            echo "‚ö†Ô∏è  WARNING: $file is larger than 500KB - consider minification"
          fi
        done
        
        echo "‚úÖ File size check completed"
    
    - name: Generate frontend test summary
      if: always()
      run: |
        echo "## üé® Frontend Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Checks Completed" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Prettier formatting check" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ ESLint linting" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ HTML validation" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ Security scan" >> $GITHUB_STEP_SUMMARY
        echo "- ‚úÖ File size check" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Node.js Version**: 18" >> $GITHUB_STEP_SUMMARY
