name: Deploy Dev Frontend to S3

permissions:
  id-token: write  # Required for OIDC
  contents: read

on:
  push:
    branches: [ develop, dev-backend-integration ]
    paths:
      - 'index.html'
      - 'resume.html'
      - 'script.js'
      - 'styles.css'
      - 'config-dev.js'
      - 'images/**'
      - '.github/workflows/deploy-frontend-dev.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment regardless of changes'
        required: false
        default: false
        type: boolean

jobs:
  deploy-dev-frontend:
    runs-on: ubuntu-latest
    environment: dev
    
    env:
      DEV_BUCKET: christopher-corbin-portfolio-dev-20251006
      DEV_WEBSITE_URL: http://christopher-corbin-portfolio-dev-20251006.s3-website-us-east-1.amazonaws.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials via OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::934862608865:role/GitHubActionsDeployRole
        aws-region: us-east-1
        role-session-name: GitHubActions-DevFrontend
        
    - name: Verify AWS CLI and credentials
      run: |
        echo "AWS CLI version:"
        aws --version
        echo "Testing AWS credentials:"
        aws sts get-caller-identity
        echo "‚úÖ AWS credentials verified via OIDC"
        
    - name: Setup Dev S3 Bucket (if needed)
      run: |
        echo "üîç Checking if dev bucket exists..."
        
        if aws s3 ls "s3://$DEV_BUCKET" 2>&1 | grep -q 'NoSuchBucket'; then
          echo "üì¶ Creating dev S3 bucket: $DEV_BUCKET"
          
          # Create bucket
          aws s3api create-bucket \
            --bucket $DEV_BUCKET \
            --region us-east-1
          
          # Enable versioning
          aws s3api put-bucket-versioning \
            --bucket $DEV_BUCKET \
            --versioning-configuration Status=Enabled
          
          # Configure website hosting
          aws s3 website s3://$DEV_BUCKET/ \
            --index-document index.html \
            --error-document index.html
          
          # Configure public access for dev
          aws s3api put-public-access-block \
            --bucket $DEV_BUCKET \
            --public-access-block-configuration \
              "BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false"
          
          # Add bucket policy for public read
          cat > /tmp/dev-bucket-policy.json << 'EOF'
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "PublicReadGetObject",
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::christopher-corbin-portfolio-dev-20251006/*"
        }
    ]
}
EOF
          
          aws s3api put-bucket-policy \
            --bucket $DEV_BUCKET \
            --policy file:///tmp/dev-bucket-policy.json
          
          # Add tags
          aws s3api put-bucket-tagging \
            --bucket $DEV_BUCKET \
            --tagging "TagSet=[{Key=Environment,Value=dev},{Key=Project,Value=christopher-corbin-portfolio},{Key=ManagedBy,Value=GitHubActions}]"
          
          echo "‚úÖ Dev bucket created and configured successfully!"
        else
          echo "‚úÖ Dev bucket already exists"
        fi
        
    - name: Prepare dev environment files
      run: |
        echo "üîß Preparing development environment..."
        
        # Replace production config with dev config in index.html
        sed -i 's|<script src="config.js"></script>|<script src="config-dev.js"></script>|g' index.html
        
        # Also update resume.html if it references config.js
        if grep -q "config.js" resume.html; then
          sed -i 's|<script src="config.js"></script>|<script src="config-dev.js"></script>|g' resume.html
        fi
        
        echo "‚úÖ Development configuration applied"
        
    - name: Validate HTML and assets
      run: |
        echo "üîç Validating development build..."
        
        # Check if required files exist
        test -f index.html || { echo "‚ùå ERROR: index.html missing"; exit 1; }
        test -f styles.css || { echo "‚ùå ERROR: styles.css missing"; exit 1; }
        test -f script.js || { echo "‚ùå ERROR: script.js missing"; exit 1; }
        test -f config-dev.js || { echo "‚ùå ERROR: config-dev.js missing"; exit 1; }
        
        # Check if dev config is properly referenced
        if ! grep -q "config-dev.js" index.html; then
          echo "‚ùå ERROR: index.html not using dev config"
          exit 1
        fi
        
        echo "‚úÖ All required files present and configured for dev"
        
    - name: Deploy to Dev S3 Bucket
      run: |
        echo "üöÄ Deploying to development S3 bucket: $DEV_BUCKET"
        
        SYNC_COMMON="--exclude '*.json' --exclude '*.sh' --exclude '*.md' --exclude '*.toml' --exclude '.DS_Store' --exclude '.git/*' --exclude '.github/*' --exclude 'node_modules/*' --exclude 'src/*' --exclude 'template.yaml' --exclude 'config.js' --exclude '*-bucket-policy.json' --exclude 'docs/*' --exclude 'aws-config/*' --exclude 'infrastructure/*' --exclude 'tests/*' --exclude '.editorconfig' --exclude '.eslintrc.json' --exclude '.prettierrc.json' --exclude 'package*.json' --exclude 'requirements*'"
        
        # 1. Sync all files with no-cache for dev (HTML)
        eval aws s3 sync . s3://$DEV_BUCKET --delete $SYNC_COMMON \
          --cache-control "no-cache,max-age=0"

        # 2. Override CSS with short cache
        aws s3 sync . s3://$DEV_BUCKET \
          --exclude "*" --include "*.css" \
          --cache-control "max-age=300"

        # 3. Override JS with short cache
        aws s3 sync . s3://$DEV_BUCKET \
          --exclude "*" --include "*.js" --exclude "config.js" \
          --cache-control "max-age=300"

        # 4. Override images with medium cache
        aws s3 sync . s3://$DEV_BUCKET \
          --exclude "*" --include "*.jpg" --include "*.jpeg" --include "*.png" --include "*.gif" --include "*.svg" --include "*.webp" --include "*.ico" --include "*.pdf" \
          --cache-control "max-age=3600"
          
        echo "‚úÖ Dev deployment completed successfully!"
        
    - name: Verify dev deployment
      run: |
        echo "üîç Verifying development deployment..."
        
        # Check if website is accessible
        HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $DEV_WEBSITE_URL || echo "000")
        
        if [ "$HTTP_STATUS" = "200" ]; then
          echo "‚úÖ SUCCESS: Dev website is accessible at $DEV_WEBSITE_URL"
          echo "üìä Development Deployment Summary:"
          aws s3 ls s3://$DEV_BUCKET --human-readable --summarize | tail -2
        else
          echo "‚ùå ERROR: Dev website not accessible. HTTP Status: $HTTP_STATUS"
          exit 1
        fi
        
    - name: Test dev backend integration
      run: |
        echo "üß™ Testing dev backend integration..."
        
        # Extract API URL from deployed config-dev.js
        API_URL="https://cdmwb9tdlj.execute-api.us-east-1.amazonaws.com/prod/contact"
        
        echo "üì° Testing API endpoint: $API_URL"
        
        # Test API health
        HTTP_STATUS=$(curl -s -w "%{http_code}" -X POST "$API_URL" \
          -H "Content-Type: application/json" \
          -d '{
            "name": "GitHub Actions Dev Test",
            "email": "dev-test@github-actions.com",
            "message": "Automated dev frontend-backend integration test"
          }' || echo "000")
        
        if [ "$HTTP_STATUS" = "200" ]; then
          echo "‚úÖ SUCCESS: Dev backend integration working!"
        else
          echo "‚ö†Ô∏è  WARNING: Dev backend test failed with HTTP $HTTP_STATUS"
          echo "This might be expected if backend is not deployed yet"
        fi
        
    - name: Generate dev deployment report
      run: |
        echo "üìã Development Deployment Report"
        echo "================================="
        echo "üåç Dev Website URL: $DEV_WEBSITE_URL"
        echo "üì¶ S3 Bucket: $DEV_BUCKET" 
        echo "üì° Backend API: https://cdmwb9tdlj.execute-api.us-east-1.amazonaws.com/prod/contact"
        echo "üïê Deploy Time: $(date)"
        echo "ü§ñ Built by: GitHub Actions (OIDC)"
        echo "üë§ Triggered by: ${{ github.actor }}"
        echo "üîó Commit: ${{ github.sha }}"
        echo ""
        echo "üìÅ Bucket Contents:"
        aws s3 ls s3://$DEV_BUCKET --human-readable
        echo ""
        echo "üéâ SUCCESS: Dev frontend deployment completed!"
        echo ""
        echo "üîó Next steps:"
        echo "   ‚Ä¢ Visit dev site: $DEV_WEBSITE_URL"
        echo "   ‚Ä¢ Test contact form integration"
        echo "   ‚Ä¢ Compare with production environment"
        echo "   ‚Ä¢ Ready for testing! üöÄ"
