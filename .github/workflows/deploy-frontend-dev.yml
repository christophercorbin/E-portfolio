name: Deploy Dev Frontend to S3

permissions:
  id-token: write  # Required for OIDC
  contents: read

on:
  push:
    branches: [ develop, dev-backend-integration ]
    paths:
      - 'index.html'
      - 'resume.html'
      - 'script.js'
      - 'styles.css'
      - 'config-dev.js'
      - 'images/**'
      - '.github/workflows/deploy-frontend-dev.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment regardless of changes'
        required: false
        default: false
        type: boolean

jobs:
  deploy-dev-frontend:
    runs-on: ubuntu-latest
    environment: dev
    
    env:
      DEV_BUCKET: christopher-corbin-portfolio-dev-20251006
      DEV_WEBSITE_URL: http://christopher-corbin-portfolio-dev-20251006.s3-website-us-east-1.amazonaws.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials via OIDC
      uses: aws-actions/configure-aws-credentials@v6
      with:
        role-to-assume: arn:aws:iam::934862608865:role/GitHubActionsDeployRole
        aws-region: us-east-1
        role-session-name: GitHubActions-DevFrontend
        
    - name: Verify AWS CLI and credentials
      run: |
        echo "AWS CLI version:"
        aws --version
        echo "Testing AWS credentials:"
        aws sts get-caller-identity
        echo "âœ… AWS credentials verified via OIDC"
        
    - name: Setup Dev S3 Bucket (if needed)
      run: |
        echo "ğŸ” Checking if dev bucket exists..."
        
        if aws s3 ls "s3://$DEV_BUCKET" 2>&1 | grep -q 'NoSuchBucket'; then
          echo "ğŸ“¦ Creating dev S3 bucket: $DEV_BUCKET"
          
          # Create bucket
          aws s3api create-bucket \
            --bucket $DEV_BUCKET \
            --region us-east-1
          
          # Enable versioning
          aws s3api put-bucket-versioning \
            --bucket $DEV_BUCKET \
            --versioning-configuration Status=Enabled
          
          # Configure website hosting
          aws s3 website s3://$DEV_BUCKET/ \
            --index-document index.html \
            --error-document index.html
          
          # Configure public access for dev
          aws s3api put-public-access-block \
            --bucket $DEV_BUCKET \
            --public-access-block-configuration \
              "BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false"
          
          # Add bucket policy for public read using inline JSON
          aws s3api put-bucket-policy \
            --bucket $DEV_BUCKET \
            --policy "{\"Version\":\"2012-10-17\",\"Statement\":[{\"Sid\":\"PublicReadGetObject\",\"Effect\":\"Allow\",\"Principal\":\"*\",\"Action\":\"s3:GetObject\",\"Resource\":\"arn:aws:s3:::$DEV_BUCKET/*\"}]}"
          
          # Add tags
          aws s3api put-bucket-tagging \
            --bucket $DEV_BUCKET \
            --tagging "TagSet=[{Key=Environment,Value=dev},{Key=Project,Value=christopher-corbin-portfolio},{Key=ManagedBy,Value=GitHubActions}]"
          
          echo "âœ… Dev bucket created and configured successfully!"
        else
          echo "âœ… Dev bucket already exists"
        fi
        
    - name: Update dev config with backend API URL
      run: |
        echo "ğŸ”§ Updating dev configuration with backend API URL..."
        chmod +x infrastructure/update-dev-config.sh
        ./infrastructure/update-dev-config.sh
        
    - name: Prepare dev environment files
      run: |
        echo "ğŸ”§ Preparing development environment..."
        
        # Replace production config with dev config in index.html
        sed -i 's|<script src="config.js"></script>|<script src="config-dev.js"></script>|g' index.html
        
        # Also update resume.html if it references config.js
        if grep -q "config.js" resume.html; then
          sed -i 's|<script src="config.js"></script>|<script src="config-dev.js"></script>|g' resume.html
        fi
        
        echo "âœ… Development configuration applied"
        
    - name: Validate HTML and assets
      run: |
        echo "ğŸ” Validating development build..."
        
        # Check if required files exist
        test -f index.html || { echo "âŒ ERROR: index.html missing"; exit 1; }
        test -f styles.css || { echo "âŒ ERROR: styles.css missing"; exit 1; }
        test -f script.js || { echo "âŒ ERROR: script.js missing"; exit 1; }
        test -f config-dev.js || { echo "âŒ ERROR: config-dev.js missing"; exit 1; }
        
        # Check if dev config is properly referenced
        if ! grep -q "config-dev.js" index.html; then
          echo "âŒ ERROR: index.html not using dev config"
          exit 1
        fi
        
        echo "âœ… All required files present and configured for dev"
        
    - name: Deploy to Dev S3 Bucket
      run: |
        echo "ğŸš€ Deploying to development S3 bucket: $DEV_BUCKET"
        
        SYNC_COMMON="--exclude '*.json' --exclude '*.sh' --exclude '*.md' --exclude '*.toml' --exclude '.DS_Store' --exclude '.git/*' --exclude '.github/*' --exclude 'node_modules/*' --exclude 'src/*' --exclude 'template.yaml' --exclude 'config.js' --exclude '*-bucket-policy.json' --exclude 'docs/*' --exclude 'aws-config/*' --exclude 'infrastructure/*' --exclude 'tests/*' --exclude '.editorconfig' --exclude '.eslintrc.json' --exclude '.prettierrc.json' --exclude 'package*.json' --exclude 'requirements*'"
        
        # 1. Sync all files with no-cache for dev (HTML)
        eval aws s3 sync . s3://$DEV_BUCKET --delete $SYNC_COMMON \
          --cache-control "no-cache,max-age=0"

        # 2. Override CSS with short cache
        aws s3 sync . s3://$DEV_BUCKET \
          --exclude "*" --include "*.css" \
          --cache-control "max-age=300"

        # 3. Override JS with short cache
        aws s3 sync . s3://$DEV_BUCKET \
          --exclude "*" --include "*.js" --exclude "config.js" \
          --cache-control "max-age=300"

        # 4. Override images with medium cache
        aws s3 sync . s3://$DEV_BUCKET \
          --exclude "*" --include "*.jpg" --include "*.jpeg" --include "*.png" --include "*.gif" --include "*.svg" --include "*.webp" --include "*.ico" --include "*.pdf" \
          --cache-control "max-age=3600"
          
        echo "âœ… Dev deployment completed successfully!"
        
    - name: Verify dev deployment
      run: |
        echo "ğŸ” Verifying development deployment..."
        
        # Check if website is accessible
        HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $DEV_WEBSITE_URL || echo "000")
        
        if [ "$HTTP_STATUS" = "200" ]; then
          echo "âœ… SUCCESS: Dev website is accessible at $DEV_WEBSITE_URL"
          echo "ğŸ“Š Development Deployment Summary:"
          aws s3 ls s3://$DEV_BUCKET --human-readable --summarize | tail -2
        else
          echo "âŒ ERROR: Dev website not accessible. HTTP Status: $HTTP_STATUS"
          exit 1
        fi
        
    - name: Test dev backend integration
      continue-on-error: true
      run: |
        echo "ğŸ§ª Testing dev backend integration..."
        
        # Try to get API URL from CloudFormation stack
        API_URL=$(aws cloudformation describe-stacks \
          --stack-name christopher-corbin-portfolio-backend-dev \
          --region us-east-1 \
          --query 'Stacks[0].Outputs[?OutputKey==`ContactFormApi`].OutputValue' \
          --output text 2>/dev/null || echo "")
        
        if [ -z "$API_URL" ] || [ "$API_URL" = "None" ]; then
          echo "âš ï¸  Dev backend stack not found or not deployed yet"
          echo "ğŸ’¡ Deploy backend first: push changes to infrastructure/ or src/ directories"
          echo "   Or manually trigger: Actions â†’ Deploy SAM Backend - Development â†’ Run workflow"
          exit 0
        fi
        
        echo "ğŸ“¡ Testing API endpoint: $API_URL"
        
        # Test API health
        response=$(curl -s -w "\n%{http_code}" -X POST "$API_URL" \
          -H "Content-Type: application/json" \
          -d '{
            "name": "GitHub Actions Dev Test",
            "email": "dev-test@github-actions.com",
            "message": "Automated dev frontend-backend integration test"
          }')
        
        http_code=$(echo "$response" | tail -n1)
        body=$(echo "$response" | head -n-1)
        
        if [ "$http_code" = "200" ]; then
          echo "âœ… SUCCESS: Dev backend integration working!"
          echo "Response: $body"
        else
          echo "âŒ Dev backend test failed - HTTP $http_code"
          echo "Response: $body"
          echo ""
          echo "ğŸ’¡ Check backend deployment logs or CloudWatch for Lambda errors"
          exit 1
        fi
        
    - name: Generate dev deployment report
      run: |
        echo "ğŸ“‹ Development Deployment Report"
        echo "================================="
        echo "ğŸŒ Dev Website URL: $DEV_WEBSITE_URL"
        echo "ğŸ“¦ S3 Bucket: $DEV_BUCKET" 
        echo "ğŸ“¡ Backend API: https://cdmwb9tdlj.execute-api.us-east-1.amazonaws.com/prod/contact"
        echo "ğŸ• Deploy Time: $(date)"
        echo "ğŸ¤– Built by: GitHub Actions (OIDC)"
        echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        echo ""
        echo "ğŸ“ Bucket Contents:"
        aws s3 ls s3://$DEV_BUCKET --human-readable
        echo ""
        echo "ğŸ‰ SUCCESS: Dev frontend deployment completed!"
        echo ""
        echo "ğŸ”— Next steps:"
        echo "   â€¢ Visit dev site: $DEV_WEBSITE_URL"
        echo "   â€¢ Test contact form integration"
        echo "   â€¢ Compare with production environment"
        echo "   â€¢ Ready for testing! ğŸš€"
