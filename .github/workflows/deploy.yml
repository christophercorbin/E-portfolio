name: Deploy Portfolio to AWS S3

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y awscli
        
    - name: Validate HTML
      run: |
        echo "ğŸ” Validating HTML structure..."
        # Check if required files exist
        test -f index.html || { echo "âŒ index.html missing"; exit 1; }
        test -f styles.css || { echo "âŒ styles.css missing"; exit 1; }
        test -f script.js || { echo "âŒ script.js missing"; exit 1; }
        echo "âœ… All required files present"
        
    - name: Deploy to S3
      env:
        S3_BUCKET: christopher-corbin-portfolio-20251005195625
      run: |
        echo "ğŸš€ Deploying to S3 bucket: $S3_BUCKET"
        
        # Sync website files with appropriate cache headers
        aws s3 sync . s3://$S3_BUCKET \
          --delete \
          --exclude "*.json" \
          --exclude "*.sh" \
          --exclude "*.md" \
          --exclude ".git/*" \
          --exclude ".github/*" \
          --exclude "node_modules/*" \
          --cache-control "text/html:max-age=300" \
          --cache-control "text/css:max-age=31536000" \
          --cache-control "application/javascript:max-age=31536000" \
          --cache-control "image/*:max-age=31536000"
          
        echo "âœ… Deployment completed successfully!"
        
    - name: Verify deployment
      env:
        S3_BUCKET: christopher-corbin-portfolio-20251005195625
        WEBSITE_URL: http://christopher-corbin-portfolio-20251005195625.s3-website-us-east-1.amazonaws.com
      run: |
        echo "ğŸ” Verifying deployment..."
        
        # Check if website is accessible
        HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $WEBSITE_URL || echo "000")
        
        if [ "$HTTP_STATUS" = "200" ]; then
          echo "âœ… Website is accessible at $WEBSITE_URL"
          echo "ğŸ“Š Deployment Summary:"
          aws s3 ls s3://$S3_BUCKET --human-readable --summarize | tail -2
        else
          echo "âŒ Website not accessible. HTTP Status: $HTTP_STATUS"
          exit 1
        fi
        
    - name: Performance check
      env:
        WEBSITE_URL: http://christopher-corbin-portfolio-20251005195625.s3-website-us-east-1.amazonaws.com
      run: |
        echo "âš¡ Running basic performance check..."
        
        # Measure response time
        RESPONSE_TIME=$(curl -s -w "%{time_total}" -o /dev/null $WEBSITE_URL)
        echo "ğŸ• Response time: ${RESPONSE_TIME}s"
        
        # Check file sizes
        echo "ğŸ“ File sizes:"
        aws s3 ls s3://christopher-corbin-portfolio-20251005195625 --human-readable | grep -E "\.(html|css|js)$" || true
        
    - name: Security scan
      run: |
        echo "ğŸ›¡ï¸ Running basic security checks..."
        
        # Check for sensitive information in files
        echo "ğŸ” Scanning for potential secrets..."
        if grep -r -i "password\|secret\|key" --include="*.html" --include="*.css" --include="*.js" . | grep -v "skill-item\|api-key\|access-key" | head -5; then
          echo "âš ï¸  Potential sensitive data found (review above)"
        else
          echo "âœ… No obvious sensitive data detected"
        fi
        
        # Check HTTPS readiness
        echo "ğŸ”’ HTTPS Readiness check..."
        if grep -q "http://" index.html; then
          echo "âš ï¸  Found HTTP links - consider updating for HTTPS"
        else
          echo "âœ… No HTTP links found"
        fi
        
    - name: Generate deployment report
      env:
        S3_BUCKET: christopher-corbin-portfolio-20251005195625
        WEBSITE_URL: http://christopher-corbin-portfolio-20251005195625.s3-website-us-east-1.amazonaws.com
      run: |
        echo "ğŸ“‹ Deployment Report"
        echo "==================="
        echo "ğŸŒ Website URL: $WEBSITE_URL"
        echo "ğŸª£ S3 Bucket: $S3_BUCKET"
        echo "ğŸ“… Deploy Time: $(date)"
        echo "ğŸ—ï¸ Built by: GitHub Actions"
        echo "ğŸ”§ Triggered by: ${{ github.actor }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo ""
        echo "ğŸ“Š Bucket Contents:"
        aws s3 ls s3://$S3_BUCKET --human-readable
        echo ""
        echo "âœ… Portfolio deployment completed successfully!"
        echo ""
        echo "ğŸ’¡ Next steps:"
        echo "   â€¢ Visit your portfolio: $WEBSITE_URL"
        echo "   â€¢ Set up custom domain with CloudFront"
        echo "   â€¢ Add SSL certificate for HTTPS"