name: Deploy SAM Backend - Production

permissions:
  id-token: write  # Required for OIDC
  contents: read

on:
  push:
    branches: [ main ]
    paths:
      - 'infrastructure/template.yaml'
      - 'src/**'
      - 'infrastructure/samconfig*.toml'
  workflow_dispatch:

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    environment: production
    
    env:
      ENVIRONMENT: prod
      STACK_NAME: christopher-corbin-portfolio-backend
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.9'
    
    - name: Setup AWS SAM CLI
      uses: aws-actions/setup-sam@v2
      with:
        use-installer: true
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v6
      with:
        role-to-assume: arn:aws:iam::590716168923:role/GitHubActionsDeployRole
        role-session-name: GitHubActions-ProdBackend
        aws-region: us-east-1
    
    - name: Validate required secrets
      run: |
        if [[ -z "${{ secrets.CONTACT_EMAIL }}" ]]; then
          echo "âŒ Error: CONTACT_EMAIL secret is not set"
          echo "Please add CONTACT_EMAIL to your GitHub repository secrets"
          exit 1
        fi
        echo "âœ… CONTACT_EMAIL secret is configured"
        
        # Set production CORS origin
        CORS_ORIGIN="*"
        if [[ -n "${{ secrets.CLOUDFRONT_DOMAIN }}" ]]; then
          CORS_ORIGIN="https://${{ secrets.CLOUDFRONT_DOMAIN }}"
        fi
        echo "CORS_ORIGIN=$CORS_ORIGIN" >> $GITHUB_ENV
    
    - name: Build SAM application
      working-directory: infrastructure
      run: sam build
    
    - name: Deploy SAM application to production
      working-directory: infrastructure
      run: |
        sam deploy \
          --resolve-s3 \
          --no-confirm-changeset \
          --no-fail-on-empty-changeset \
          --stack-name $STACK_NAME \
          --capabilities CAPABILITY_IAM \
          --region us-east-1 \
          --parameter-overrides \
            "ContactEmail=${{ secrets.CONTACT_EMAIL }}" \
            "CorsOrigin=$CORS_ORIGIN" \
            "Environment=$ENVIRONMENT"
    
    - name: Get production API URL
      run: |
        echo "â³ Retrieving production API Gateway URL..."
        API_URL=$(aws cloudformation describe-stacks \
          --stack-name $STACK_NAME \
          --region us-east-1 \
          --query 'Stacks[0].Outputs[?OutputKey==`ContactFormApi`].OutputValue' \
          --output text)
        
        if [[ -n "$API_URL" && "$API_URL" != "None" ]]; then
          echo "âœ… Production Contact API URL: $API_URL"
          echo "API_URL=$API_URL" >> $GITHUB_ENV
          echo "ðŸš€ Production backend is now live!"
        else
          echo "âŒ Error: Could not retrieve production API URL"
          exit 1
        fi
    
    - name: Test production API endpoint
      run: |
        echo "ðŸ§ª Testing production API endpoint..."
        response=$(curl -s -w "%{http_code}" -X POST "$API_URL" \
          -H "Content-Type: application/json" \
          -d '{
            "name": "Production Deployment Test",
            "email": "production-test@github-actions.com", 
            "message": "Automated production deployment verification test"
          }')
        
        http_code=${response: -3}
        if [[ $http_code -eq 200 ]]; then
          echo "âœ… Production API test passed - HTTP $http_code"
        else
          echo "âŒ Production API test failed - HTTP $http_code"
          echo "Response: ${response%???}"
          exit 1
        fi
    
    - name: Install test dependencies
      run: |
        echo "ðŸ“¦ Installing test dependencies..."
        pip install requests pytest pytest-cov
    
    - name: Run integration tests
      run: |
        echo "ðŸ§ª Running integration tests against production API..."
        export API_URL="$API_URL"
        pytest tests/integration/test_deployed_api.py -v --tb=short
      continue-on-error: false
    
    - name: Update frontend configuration
      run: |
        echo "ðŸ“ Updating frontend configuration..."
        echo "VITE_CONTACT_API_URL=$API_URL" > .env.production
        echo "âœ… Frontend configuration updated"
    
    - name: Create deployment summary
      run: |
        echo "## ðŸŽ‰ Production Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Deployment Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
        echo "- **Stack Name**: \`$STACK_NAME\`" >> $GITHUB_STEP_SUMMARY
        echo "- **API URL**: \`$API_URL\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Region**: us-east-1" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Verification Complete" >> $GITHUB_STEP_SUMMARY
        echo "- [x] API endpoint is responding" >> $GITHUB_STEP_SUMMARY
        echo "- [x] CORS configuration verified" >> $GITHUB_STEP_SUMMARY
        echo "- [x] Email notifications enabled" >> $GITHUB_STEP_SUMMARY
        echo "- [x] DynamoDB table created" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Next Steps" >> $GITHUB_STEP_SUMMARY  
        echo "1. Test the contact form on your live portfolio" >> $GITHUB_STEP_SUMMARY
        echo "2. Verify email notifications are working" >> $GITHUB_STEP_SUMMARY
        echo "3. Monitor CloudWatch logs for any issues" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽŠ Your contact form backend is now live in production!" >> $GITHUB_STEP_SUMMARY
    
    - name: Notify on success
      run: |
        echo "ðŸŽ‰ Production deployment completed successfully!"
        echo "ðŸŒŸ Contact form backend is now live and ready to use!"
        echo "ðŸ“§ Test it by submitting a message through your portfolio contact form"